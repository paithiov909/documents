---
ID: ff3030bec8dc3d317128
Title: RからMeCabの制約付き解析をやる
Tags: R,mecab,自然言語処理,形態素解析
Author: Kato Akiru
Private: false
---

## この記事について

[自作のRパッケージ](https://github.com/paithiov909/rjavacmecab)を利用してRからMeCabの制約付き解析をおこないます。RからといってもタガーからprogramaticallyにMeCabを呼んでやるのではなく、`system`から外部コマンドとしてMeCabをオプション付きで呼ぶことでおこないます。このRパッケージの利用方法については[ここ](https://paithiov909.github.io/rjavacmecab/articles/about.html)を読んでください。パッケージの最新のリリースによる実行例は[これ](https://paithiov909.github.io/rjavacmecab/articles/partial.html)です。

このパッケージは{rJava}に依存しているため、環境によってはインストールに手こずることがあります。`system`経由でMeCabを呼ぶのはそれほど難しくないので、パッケージの関数を使わずに自分でやりたい場合には、[この記事](http://wanko-sato.hatenablog.com/entry/2017/01/09/095645)などを参考にするとよいです。また、形態素断片を与えるのではなく、たとえば文字種などを見て形態素境界に制約を付けるような使い方をしたい場合には`Lattice::set_boundary_constraint`を利用してprogramaticallyにやるしかありません。これはRからはやりようがないので、公式に用意されているバインディングを利用する必要があります。Pythonからおこなう場合、[この記事](https://qiita.com/yukinoi/items/4e7afb5e72b3a46da0f2)や[この記事](http://kensuke-mi.hatenablog.com/entry/2015/03/09/213528)が参考になります。

## MeCabにコマンドラインオプションを渡す

`rjavacmecab::fastestword`は`system`関数からMeCabを外部コマンドとして直接実行することができるものです。このとき、MeCabのコマンドラインオプションをoptに引数として渡すことで、オプション付きでMeCabを実行することができます。

### -Owakati での実行例

```r
output_path <- rjavacmecab::fastestword(
  "みなさまが、焼き餃子だと居間で噂するクラッチを持たせていただきました",
  opt = "-Owakati", ## equal to default behavior.
  encoding = "CP932"
)
readLines(output_path)
#> [1] "みなさま が 、 焼き 餃子 だ と 居間 で 噂 する クラッチ を 持た せ て いただき まし た "
```

## 制約付き解析（部分解析）の一例

MeCabのやや発展的な使い方のひとつとして、[制約付き解析](https://taku910.github.io/mecab/partial.html)があります。

> 入力文の一部の形態素情報が既知である、あるいは境界がわかっているときに、 それを満たすように解析する機能です。
> 
> たとえば、「にわにはにわにわとりがいる。」という文に対して、 「はにわ」の部分が名詞であるとか、「にわとり」の部分が一つの形態素 であるというように指定した上で解析することができます。このとき、 制約に反する4文字目の「は」が単独で形態素となったり、「にわとり」が「にわ」と「とり」 に分割されるような解析候補は排除されます。

ここでは**「くぅ～きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～」**（意訳：うわー、きゃりーぱみゅぱみゅちゃんのPVはすごくかわいいなぁ）という文を意図どおりに解析させることを試みます。

### IPA辞書による素の解析の場合

標準のIPA辞書で解析するとうまく解析されていません。

```r
input_text <- c("くぅ～きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～")
output_path <- rjavacmecab::fastestword(
  input_text,
  opt = "", ## MeCab標準の形式で出力させるために空文字をオプションとして渡す
  encoding = "CP932"
)
file <- readLines(output_path)
readr::read_tsv(
  file,
  col_names = FALSE,
  quote = "",
  n_max = length(file) - 1L
)
#> # A tibble: 11 x 2
#>    X1                  X2                                                       
#>    <chr>               <chr>                                                    
#>  1 くぅ                形容詞,自立,*,*,形容詞・アウオ段,連用ゴザイ接続,くい,クゥ,クー~
#>  2 ～                  記号,一般,*,*,*,*,～,～,～                               
#>  3 き                  動詞,自立,*,*,カ変・クル,連用形,くる,キ,キ               
#>  4 ゃり                名詞,一般,*,*,*,*,*                                      
#>  5 ー                  名詞,一般,*,*,*,*,*                                      
#>  6 ぱみゅぱみゅたそのぴ~ 名詞,一般,*,*,*,*,*                                      
#>  7 ー                  名詞,一般,*,*,*,*,*                                      
#>  8 ぶ                  動詞,自立,*,*,五段・ラ行,体言接続特殊２,ぶる,ブ,ブ       
#>  9 い                  動詞,非自立,*,*,一段,連用形,いる,イ,イ                   
#> 10 ぐうかわっすよ      名詞,一般,*,*,*,*,*                                      
#> 11 ～                  記号,一般,*,*,*,*,～,～,～
```

MeCabはデフォルトだと未知語についても品詞推定をおこないますが、推定された未知語の多くは名詞一般になります。未知語と判定された形態素について品詞推定をせず、特定の素性パターンを表示させるには次のようにします。

```r
input_text <- c("くぅ～きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～")
output_path <- rjavacmecab::fastestword(
  input_text,
  opt = "--unk-feature Unknown",
  encoding = "CP932"
)
file <- readLines(output_path)
readr::read_tsv(
  file,
  col_names = FALSE,
  quote = "",
  n_max = length(file) - 1L
)
#> # A tibble: 11 x 2
#>    X1                  X2                                                       
#>    <chr>               <chr>                                                    
#>  1 くぅ                形容詞,自立,*,*,形容詞・アウオ段,連用ゴザイ接続,くい,クゥ,クー~
#>  2 ～                  記号,一般,*,*,*,*,～,～,～                               
#>  3 き                  動詞,自立,*,*,カ変・クル,連用形,くる,キ,キ               
#>  4 ゃり                Unknown                                                  
#>  5 ー                  Unknown                                                  
#>  6 ぱみゅぱみゅたそのぴ~ Unknown                                                  
#>  7 ー                  Unknown                                                  
#>  8 ぶ                  動詞,自立,*,*,五段・ラ行,体言接続特殊２,ぶる,ブ,ブ       
#>  9 い                  動詞,非自立,*,*,一段,連用形,いる,イ,イ                   
#> 10 ぐうかわっすよ      Unknown                                                  
#> 11 ～                  記号,一般,*,*,*,*,～,～,～
```

### 制約付き解析の場合

`rjavacmecab::fastestword`は与えられた文字列ベクトルをそのまま`writeLines`に渡し、書き出したファイルをMeCabに解析させます。`writeLines`に渡された文字列ベクトルは要素ごとにsepで指定した文字で区切られて書き出される（デフォルトでは改行で区切られる）ため、制約付き解析をする場合は以下のような形式の文字列を用意します。

```r
input_text <- c(
  "くぅ～\t感動詞", ## 形態素断片とその素性パターンは"\t"で区切る
  "きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～", ## 通常の文字列は文断片として処理される
  "EOS" ## 改行を含む文を部分解析モードで解析する場合、文末記号として"EOS"を与える
)

output_path <- rjavacmecab::fastestword(
  input_text,
  opt = "--partial --unk-feature Unknown",
  encoding = "CP932"
)
file <- readLines(output_path)
readr::read_tsv(
  file,
  col_names = FALSE,
  quote = "",
  n_max = length(file) - 1L
)
#> # A tibble: 10 x 2
#>    X1                   X2                                                      
#>    <chr>                <chr>                                                   
#>  1 くぅ～               感動詞                                                  
#>  2 きゃ                 動詞,非自立,*,*,五段・カ行促音便,仮定縮約１,く,キャ,キャ
#>  3 り                   助動詞,*,*,*,文語・リ,基本形,り,リ,リ                   
#>  4 ー                   Unknown                                                 
#>  5 ぱみゅぱみゅたそのぴ Unknown                                                 
#>  6 ー                   Unknown                                                 
#>  7 ぶ                   動詞,自立,*,*,五段・ラ行,体言接続特殊２,ぶる,ブ,ブ      
#>  8 い                   動詞,非自立,*,*,一段,連用形,いる,イ,イ                  
#>  9 ぐうかわっすよ       Unknown                                                 
#> 10 ～                   記号,一般,*,*,*,*,～,～,～
```

実用的には、たとえば次のように使うことができます。

```r
input_text <- c("くぅ～きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～") %>%
  purrr::map_chr(function(str) {
    str %>%
      stringr::str_replace_all("くぅ～", "くぅ～\t感動詞\n") %>%
      stringr::str_replace_all("きゃりーぱみゅぱみゅ", "きゃりーぱみゅぱみゅ\t名詞,固有名詞,人名,一般\n") %>%
      stringr::str_replace_all("たそ", "たそ\t名詞,接尾,人名\n") %>%
      stringr::str_replace_all("ぴーぶい", "ぴーぶい\t名詞,一般\n") %>%
      stringr::str_replace_all("ぐうかわ", "ぐうかわ\t名詞,形容動詞語幹\n")
  }) %>%
  c("EOS")

output_path <- rjavacmecab::fastestword(
  input_text,
  opt = "--partial",
  encoding = "CP932"
)
file <- readLines(output_path)
out <- file %>%
  readr::read_tsv(
    col_names = FALSE,
    quote = "",
    n_max = length(file) - 1L
  ) %>%
  tidyr::separate(
    col = X2,
    into = c(
      "品詞",
      "品詞細分類1",
      "品詞細分類2",
      "品詞細分類3",
      "活用形",
      "活用型",
      "原形",
      "読み",
      "発音"
    ),
    sep = ",",
    fill = "right"
  )
out
#> # A tibble: 8 x 10
#>   X1    品詞  品詞細分類1 品詞細分類2 品詞細分類3 活用形 活用型 原形  読み 
#>   <chr> <chr> <chr>       <chr>       <chr>       <chr>  <chr>  <chr> <chr>
#> 1 くぅ～~ 感動詞~ <NA>        <NA>        <NA>        <NA>   <NA>   <NA>  <NA> 
#> 2 きゃりー~ 名詞  固有名詞    人名        一般        *      *      *     <NA> 
#> 3 たそ  名詞  接尾        人名        <NA>        <NA>   <NA>   <NA>  <NA> 
#> 4 のぴーぶ~ 名詞  一般        *           *           *      *      *     <NA> 
#> 5 ぐうかわ~ 名詞  形容動詞語幹~ <NA>        <NA>        <NA>   <NA>   <NA>  <NA> 
#> 6 っす  助動詞~ *           *           *           特殊・デス~ 基本形 っす  ッス 
#> 7 よ    助詞  終助詞      *           *           *      *      よ    ヨ   
#> 8 ～    記号  一般        *           *           *      *      ～    ～   
#> # ... with 1 more variable: 発音 <chr>
```

また、形態素断片の素性パターンにワイルドカードを使うとその単語を切り出しながら品詞については適当なものを付与させることができます。以下では「の」と「ぴーぶい」については常に単語として切り出しながら、品詞は適当なものを付与させています。ユーザー辞書で未知語を定義する場合と比べて、形態素としての区切りは与えながらも品詞の推定はMeCabにやらせたいという場合に使うことができます。

```r
input_text <- c("くぅ～きゃりーぱみゅぱみゅたそのぴーぶいぐうかわっすよ～") %>%
  purrr::map_chr(function(str) {
    str %>%
      stringr::str_replace_all("くぅ～", "くぅ～\t感動詞\n") %>%
      stringr::str_replace_all("きゃりーぱみゅぱみゅ", "きゃりーぱみゅぱみゅ\t名詞,固有名詞,人名,一般\n") %>%
      stringr::str_replace_all("たそ", "たそ\t名詞,接尾,人名\n") %>%
      stringr::str_replace_all("の", "の\t*\n") %>%
      stringr::str_replace_all("ぴーぶい", "ぴーぶい\t*\n") %>%
      stringr::str_replace_all("ぐうかわ", "ぐうかわ\t名詞,形容動詞語幹\n")
  }) %>%
  c("EOS")

output_path <- rjavacmecab::fastestword(
  input_text,
  opt = "--partial",
  encoding = "CP932"
)
file <- readLines(output_path)
out <- file %>%
  readr::read_tsv(
    col_names = FALSE,
    quote = "",
    n_max = length(file) - 1L
  ) %>%
  tidyr::separate(
    col = X2,
    into = c(
      "品詞",
      "品詞細分類1",
      "品詞細分類2",
      "品詞細分類3",
      "活用形",
      "活用型",
      "原形",
      "読み",
      "発音"
    ),
    sep = ",",
    fill = "right"
  )
out
#> # A tibble: 9 x 10
#>   X1    品詞  品詞細分類1 品詞細分類2 品詞細分類3 活用形 活用型 原形  読み 
#>   <chr> <chr> <chr>       <chr>       <chr>       <chr>  <chr>  <chr> <chr>
#> 1 くぅ～~ 感動詞~ <NA>        <NA>        <NA>        <NA>   <NA>   <NA>  <NA> 
#> 2 きゃりー~ 名詞  固有名詞    人名        一般        *      *      *     <NA> 
#> 3 たそ  名詞  接尾        人名        <NA>        <NA>   <NA>   <NA>  <NA> 
#> 4 の    助詞  連体化      *           *           *      *      の    ノ   
#> 5 ぴーぶい~ 名詞  一般        *           *           *      *      *     <NA> 
#> 6 ぐうかわ~ 名詞  形容動詞語幹~ <NA>        <NA>        <NA>   <NA>   <NA>  <NA> 
#> 7 っす  助動詞~ *           *           *           特殊・デス~ 基本形 っす  ッス 
#> 8 よ    助詞  終助詞      *           *           *      *      よ    ヨ   
#> 9 ～    記号  一般        *           *           *      *      ～    ～   
#> # ... with 1 more variable: 発音 <chr>
```

## 参考

- [Mecabなど形態素解析で使うIPA品詞体系（品詞ID｜pos-id） - MS Tech](http://miner.hatenablog.com/entry/323)
- [MeCabの制約付き解析モードを利用する - kensuke-miの日記](http://kensuke-mi.hatenablog.com/entry/2015/03/09/213528)
