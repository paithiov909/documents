---
ID: 4777d371178aa7b98b4e
Title: RStudioCloudでMeCabで形態素解析する方法
Tags: R,mecab,形態素解析
Author: Kato Akiru
Private: false
---

## はじめに

2020年10月現在のRStudio Cloudは依然としてやや特殊な環境ですが、reticulateを使えるようにするためにPython（Miniconda）などが入るようにできています。起ち上げた直後に右下に表示されているペインからはルートディレクトリ以下の`/cloud/project`というディレクトリよりも下が見えていますが、ユーザーディレクトリ（`system("echo $HOME")`すると`/home/rstudio-user`と確認できる）の直下に`.local`という書き込み権限があるディレクトリがあり、たとえば`reticulate::install_miniconda()`した場合には`$HOME/.local/share/r-miniconda`にMinicondaがインストールされます。

MeCabを公式で案内されている手順にしたがってインストールしようとするとsudoが必要なため詰まりますが、以下の記事などで案内されているように、makeするときにprefixを指定すれば書き込み権限がある場所にインストールできるため、RStudioCloud内でもMeCabを使うことは可能です。

- [sudoが使えないマシンでmecabを使うまでの備忘録 - Qiita](https://qiita.com/kadotami/items/57bc2fbb5132b79c7efe)

## 手順

### MeCabのインストール

Rコンソールからやってもよいのですが、Terminalペインがあるのでそちらでやります。

```bash
$ wget "https://drive.google.com/uc?export=download&id=0B4y35FiV1wh7cENtOXlicTFaRUE" -O mecab-0.996.tar.gz
$ tar xvf mecab-0.996.tar.gz
$ cd mecab-0.996
$ ./configure --prefix=$HOME/.local --with-charset=utf8 --enable-utf8-only
$ make
$ make install
```

パスはターミナル上でexportしてもRのセッションの方には影響しないためこれで終わりです。

### IPA辞書のインストール

ターミナル上でダウンロードして展開しておきます。

```bash
$ wget "https://drive.google.com/uc?export=download&id=0B4y35FiV1wh7MWVlSDBCSXZMTXM" -O mecab-ipadic-2.7.0-20070801.tar.gz
$ tar xvzf mecab-ipadic-2.7.0-20070801.tar.gz
$ cd mecab-ipadic-2.7.0-20070801
```

このあと辞書をmakeするわけですが、mecab-configにパスが通っていないとかでターミナルからだとコケるので、続きはRコンソールからやります。まず、パスを追記します。

```r
> Sys.setenv(PATH = paste(Sys.getenv("PATH"), "/home/rstudio-user/.local/bin", "/home/rstudio-user/.local/lib", sep = ":"))
```

これで辞書がビルドできます。次のようにします。

```r
> setwd("./mecab-ipadic-2.7.0-20070801")
> system("bash ./configure --with-charset=utf8 --with-dicdir=/home/rstudio-user/.local/mecab-dic/ipadic-utf8")
> system("make")
> system("make install")
> setwd("../")
```

## MeCabをRから利用する

これでMeCabは入ったわけですが、実は[RMeCab](https://github.com/IshidaMotohiro/RMeCab/blob/master/src/Makevars#L5)はLinuxの場合、ソースからビルドするときに見にいくlibmecab.soが`/usr/local/lib`にある前提であるためインストールに失敗します。また、RcppMeCabについても、2020年10月現在だとなぜかはわかりませんがやはりソースからのビルドに失敗するため入りません。

慣れないと使いづらいかもしれませんが、以下の筆者が自作したパッケージを使うといちおうRStudioCloudでもMeCabを利用できます。

- [paithiov909/gibasa: Slower but Cleaner RMeCab Alternative](https://github.com/paithiov909/gibasa)

### パッケージのインストール

```r
> install.packages("remotes")
> remotes::install_github("paithiov909/gibasa")
```

他のパッケージへの依存がない小さなパッケージであるため、インストールはすぐに終わります。

この記事の内容とは直接の関係はありませんが、とりわけRStudioCloudで依存先の多いパッケージを`install_github`を使って入れていく場合、どうもリクエストの制限に遭いやすい気がするので注意が必要です。以下の記事などを参考にして、あらかじめ`GITHUB_PAT`にアクセストークンを設定しておくことをおすすめします。

- [RパッケージをGitHubからインストールする場合はPersonal Access Tokenを取得・設定しておきましょう - cucumber flesh](https://uribo.hatenablog.com/entry/2019/01/11/082000)

### 使い方

`gibasa::fastestword`は`system`でmecabコマンドをラップしただけのものなので、解析したい文字列ベクトルとmecabコマンドのオプションを渡して使います。注意点として、デフォルトのディレクトリとは異なる場所に辞書を配置したので`-d /home/rstudio-user/.local/mecab-dic/ipadic-utf8`としてシステム辞書の場所を指定しないとこの環境では動きません。また、解析するたびごとに実際にファイルを書き出すのでループのなかで何回も呼ぶような使い方には向いていません。

わかち書き（-Owakatiオプション）がやりたい場合、次のようにします。

```r
> output_path <- gibasa::fastestword(
+    "みなさまが、焼き餃子だと居間で噂するクラッチを持たせていただきました",
+    opt = "-Owakati -d /home/rstudio-user/.local/mecab-dic/ipadic-utf8"
+ )
> readLines(output_path)
[1] "みなさま が 、 焼き 餃子 だ と 居間 で 噂 する クラッチ を 持た せ て いただき まし た "
```

-Ochasenオプションや他のオプションを使うこともできます。

```r
> output_path <- gibasa::fastestword(
+   "みなさまが、焼き餃子だと居間で噂するクラッチを持たせていただきました",
+   opt = "-Ochasen -d /home/rstudio-user/.local/mecab-dic/ipadic-utf8"
+ )
> file <- readLines(output_path)
> readr::read_tsv(
+   file,
+   col_names = FALSE,
+   quote = "",
+   n_max = length(file) - 1L ## Suppress warning message that EOS line can't be parsed.
+ )
# A tibble: 19 x 6
   X1       X2       X3       X4               X5               X6    
   <chr>    <chr>    <chr>    <chr>            <chr>            <chr> 
 1 みなさま ミナサマ みなさま 名詞-代名詞-一般 NA               NA    
 2 が       ガ       が       助詞-格助詞-一般 NA               NA    
 3 、       、       、       記号-読点        NA               NA    
 4 焼き     ヤキ     焼く     動詞-自立        五段・カ行イ音便 連用形
 5 餃子     ギョウザ 餃子     名詞-一般        NA               NA    
 6 だ       ダ       だ       助動詞           特殊・ダ         基本形
 7 と       ト       と       助詞-格助詞-引用 NA               NA    
 8 居間     イマ     居間     名詞-一般        NA               NA    
 9 で       デ       で       助詞-格助詞-一般 NA               NA    
10 噂       ウワサ   噂       名詞-サ変接続    NA               NA    
11 する     スル     する     動詞-自立        サ変・スル       基本形
12 クラッチ クラッチ クラッチ 名詞-一般        NA               NA    
13 を       ヲ       を       助詞-格助詞-一般 NA               NA    
14 持た     モタ     持つ     動詞-自立        五段・タ行       未然形
15 せ       セ       せる     動詞-接尾        一段             連用形
16 て       テ       て       助詞-接続助詞    NA               NA    
17 いただき イタダキ いただく 動詞-非自立      五段・カ行イ音便 連用形
18 まし     マシ     ます     助動詞           特殊・マス       連用形
19 た       タ       た       助動詞           特殊・タ         基本形
```

## RStudioCloudでPOS taggingするべつの方法

RStudioCloudはMeCabを利用するにはそれほど便利じゃないのでべつの方法も考えたほうがよいかもしれません。

- [rJava Interface to Kuromoji • tangela](https://paithiov909.github.io/tangela/)
    - atilika/kuromojiのrJavaラッパーです
 。RStudioCloudにはJavaははじめから適切に入れられているのですぐに使えます。
- Pure PythonのPOS taggerをreticulateから使う選択肢があります。
- udpipeからUniversal Dependenciesを利用できます。
